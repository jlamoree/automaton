server {
	listen @NGINX_PORT@;
	server_name @NGINX_HOST@;

	proxy_headers_hash_bucket_size 128;
	proxy_headers_hash_max_size 2048;

	access_log @NGINX_LOGS@/@NGINX_HOST@_access.log;
	error_log @NGINX_LOGS@/@NGINX_HOST@_error.log warn;
	rewrite_log on;

	set $secure_endpoint false;
	if ($scheme = https) {
		set $secure_endpoint true;
	}

	set $ua $http_user_agent;

	location = /Auth/sessionDetails {
		set $ua "StatelessAjaxClient";
		set $args sessionId=$cookie_jsessionid;
		rewrite /(.*) /stateless/index.cfm/$1 last;
	}

	location = / {
		rewrite ^ /public/index.cfm last;
	}
	
	location = /index.cfm {
		rewrite ^ /public/index.cfm last;
	}

	location ~ ^/doc/?$ {
		rewrite ^ /doc/html/index.html redirect;
	}

	location ~ ^/(favicon\.ico)$ {
		expires 1y;
		root @WEBAPP_PATH@;
	}

	location ~ ^/(images|js|css)/ {
		expires 24h;
		root @WEBAPP_PATH@;
	}

	location ~* ^/(config|handlers|interceptors|layouts|model|views)/ {
		return 403;
	}

	location ~* ^/(railo-context|mxunit|test|doc)/ {
		rewrite /(.*) /private/$1 last;
	}

	location / {
		if ($uri ~* ^/[a-z/0-9]+$) {
			rewrite /(.*) /public/index.cfm/$1 last;
		}
	}


	location ~ ^/private/ {
		internal;
		#allow 10.0.0.0/8;
		allow 127.0.0.1;
		deny all;
		rewrite ^/private/(.*)$ /$1 break;

		proxy_pass http://@WEBAPP_IP@:@WEBAPP_PORT@;
		proxy_redirect / /;
		proxy_set_header Host $host;
		proxy_read_timeout 480;
		proxy_buffering off;
	}
	
	location ~ ^/public/ {
		internal;
		rewrite ^/public/(.*)$ /$1 break;
		
		proxy_pass http://@WEBAPP_IP@:@WEBAPP_PORT@;
		proxy_redirect / /;
		proxy_set_header Host $host;
		proxy_set_header User-Agent $ua;
		proxy_set_header @APP_PROXY_SERVER_HOST_HEADER_NAME@ $host;
		proxy_set_header @APP_PROXY_SERVER_ADDRESS_HEADER_NAME@ $server_addr;
		proxy_set_header @APP_PROXY_SERVER_PORT_HEADER_NAME@ $server_port;
		proxy_set_header @APP_PROXY_SECURE_ENDPOINT_HEADER_NAME@ $secure_endpoint;
		proxy_set_header @APP_PROXY_CLIENT_ADDRESS_HEADER_NAME@ $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-NGINX-TC-Remote-IP $remote_addr;
		proxy_set_header X-NGINX-TC-Protocol $scheme;
		proxy_connect_timeout 15;
		proxy_read_timeout 1800;
	}
	
	location ~ ^/stateless/ {
		internal;
		rewrite ^/stateless/(.*)$ /$1 break;
		
		proxy_pass http://@WEBAPP_IP@:@WEBAPP_PORT@;
		proxy_set_header User-Agent $ua;
		proxy_set_header Cookie "stripped=true";
	}
	
}